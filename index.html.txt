<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ—©ä¼šè¿›åº¦å¡«æŠ¥ - ProgressGuard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #f9f9f9; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; color: #333; }
    .date-info { text-align: center; margin: 10px 0; font-weight: bold; }
    .form-group { margin: 15px 0; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input, select, textarea { width: 10; padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
    button { background: #1890ff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
    button:hover { background: #40a9ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
    th { background: #f0f0f0; }
    .highlight-red { background-color: #ffe6e6 !important; }
    .highlight-yellow { background-color: #fff7e6 !important; }
    .hidden { display: none; }
    .login-section, .main-section { transition: opacity 0.3s; }
  </style>
</head>
<body>
  <div class="container">
    <!-- ç™»å½•åŒº -->
    <div id="loginSection" class="login-section">
      <h1>æ—©ä¼šå¡«æŠ¥ç³»ç»Ÿ</h1>
      <div class="form-group">
        <label for="empName">è¯·è¾“å…¥ä½ çš„å§“åï¼š</label>
        <input type="text" id="empName" placeholder="å¦‚ï¼šå¼ ä¸‰" />
      </div>
      <button onclick="login()">è¿›å…¥å¡«æŠ¥</button>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div id="mainSection" class="main-section hidden">
      <h1 id="pageTitle">æ—©ä¼šå¡«æŠ¥</h1>
      <div class="date-info" id="dateInfo"></div>
      <div id="weekdayContent"></div>
      <div id="weekendContent" class="hidden"></div>
    </div>
  </div>

  <script>
    // ğŸ”‘ æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Supabase ä¿¡æ¯ï¼ˆä¸‹ä¸€æ­¥æ•™ä½ å¡«ï¼‰
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentEmployee = '';
    const DIMENSIONS = ['å®¢æˆ·è·Ÿè¿›', 'ä»£ç å¼€å‘', 'æ–‡æ¡£æ’°å†™', 'æµ‹è¯•éªŒè¯', 'ä¼šè®®åè°ƒ']; // å¯æŒ‰éœ€ä¿®æ”¹

    // è·å–ä»Šå¤©æ˜¯å‘¨å‡ ï¼ˆ0=å‘¨æ—¥, 1=å‘¨ä¸€...6=å‘¨å…­ï¼‰
    function getDayOfWeek(date) {
      return date.getDay();
    }

    // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // æ£€æµ‹æ˜¯å¦ä¸ºå·¥ä½œæ—¥
    function isWeekday() {
      const today = new Date();
      const day = getDayOfWeek(today);
      return day >= 1 && day <= 5; // å‘¨ä¸€åˆ°å‘¨äº”
    }

    // ç™»å½•
    function login() {
      const name = document.getElementById('empName').value.trim();
      if (!name) {
        alert('è¯·è¾“å…¥å§“å');
        return;
      }
      currentEmployee = name;
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('mainSection').classList.remove('hidden');
      renderPage();
    }

    // æ¸²æŸ“é¡µé¢
    async function renderPage() {
      const today = new Date();
      const dateStr = formatDate(today);
      const dayOfWeek = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'][getDayOfWeek(today)];

      document.getElementById('dateInfo').innerText = `${dateStr} ${dayOfWeek}`;

      if (isWeekday()) {
        document.getElementById('pageTitle').innerText = 'ä»Šæ—¥å·¥ä½œå¡«æŠ¥';
        document.getElementById('weekendContent').classList.add('hidden');
        document.getElementById('weekdayContent').classList.remove('hidden');
        await renderWeekdayForm(dateStr);
      } else {
        document.getElementById('pageTitle').innerText = 'æœ¬å‘¨æ±‡æ€»';
        document.getElementById('weekdayContent').classList.add('hidden');
        document.getElementById('weekendContent').classList.remove('hidden');
        await renderWeekSummary();
      }
    }

    // æ¸²æŸ“å·¥ä½œæ—¥å¡«æŠ¥è¡¨å•
    async function renderWeekdayForm(dateStr) {
      let html = `<div class="form-group">
                    <label>å·¥ä½œç»´åº¦</label>
                    <label>å½“å‰çŠ¶æ€</label>
                    <label>è¿›å±•è¯´æ˜ï¼ˆé™100å­—ï¼‰</label>
                  </div>`;

      for (const dim of DIMENSIONS) {
        // è·å–å·²æœ‰æ•°æ®
        let existing = { progress_status: 'è¿›è¡Œä¸­', notes: '' };
        const { data } = await supabase
          .from('daily_progress')
          .select('progress_status, notes')
          .eq('employee_name', currentEmployee)
          .eq('date', dateStr)
          .eq('task_dimension', dim)
          .single();

        if (data) existing = data;

        html += `
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <div style="width: 120px; padding-top: 8px;">${dim}</div>
            <select id="status-${dim.replace(/\s/g, '_')}">
              <option value="æœªå¼€å§‹" ${existing.progress_status === 'æœªå¼€å§‹' ? 'selected' : ''}>æœªå¼€å§‹</option>
              <option value="è¿›è¡Œä¸­" ${existing.progress_status === 'è¿›è¡Œä¸­' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
              <option value="æœ‰æ–°è¿›å±•" ${existing.progress_status === 'æœ‰æ–°è¿›å±•' ? 'selected' : ''}>æœ‰æ–°è¿›å±•</option>
              <option value="å·²é˜»å¡" ${existing.progress_status === 'å·²é˜»å¡' ? 'selected' : ''}>å·²é˜»å¡</option>
              <option value="å·²å®Œæˆ" ${existing.progress_status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
            </select>
            <textarea id="notes-${dim.replace(/\s/g, '_')}" maxlength="100" placeholder="ç®€è¦è¯´æ˜ï¼ˆå¦‚ï¼šè”ç³»äº†å®¢æˆ·Aï¼Œéœ€æ±‚ç¡®è®¤ä¸­ï¼‰">${existing.notes}</textarea>
          </div>
        `;
      }

      html += `<button onclick="saveTodayData('${dateStr}')">æäº¤ä»Šæ—¥è¿›åº¦</button>`;
      html += `<p style="font-size:12px; color:#666;">æäº¤åä¸å¯ä¿®æ”¹ï¼Œè¯·è®¤çœŸå¡«å†™ã€‚</p>`;
      document.getElementById('weekdayContent').innerHTML = html;
    }

    // ä¿å­˜æ•°æ®
    async function saveTodayData(dateStr) {
      for (const dim of DIMENSIONS) {
        const status = document.getElementById(`status-${dim.replace(/\s/g, '_')}`).value;
        const notes = document.getElementById(`notes-${dim.replace(/\s/g, '_')}`).value.trim();

        // é™åˆ¶å­—æ•°
        if (notes.length > 100) {
          alert('è¯´æ˜ä¸èƒ½è¶…è¿‡100å­—');
          return;
        }

        // Upsertï¼ˆå­˜åœ¨åˆ™æ›´æ–°ï¼Œå¦åˆ™æ’å…¥ï¼‰
        await supabase
          .from('daily_progress')
          .upsert(
            {
              employee_name: currentEmployee,
              date: dateStr,
              task_dimension: dim,
              progress_status: status,
              notes: notes
            },
            { onConflict: 'employee_name,date,task_dimension' }
          );
      }
      alert('âœ… æäº¤æˆåŠŸï¼æ˜å¤©è§~');
    }

    // æ¸²æŸ“å‘¨æœ«æ±‡æ€»
    async function renderWeekSummary() {
      // è·å–æœ¬å‘¨ä¸€åˆ°å‘¨äº”
      const today = new Date();
      const day = today.getDay(); // 0=å‘¨æ—¥, 6=å‘¨å…­
      let monday = new Date(today);
      if (day === 0) monday.setDate(today.getDate() - 6); // å‘¨æ—¥ â†’ å¾€å‰6å¤©
      else monday.setDate(today.getDate() - (day - 1)); // å‘¨å…­ â†’ å¾€å‰5å¤©

      const dates = [];
      for (let i = 0; i < 5; i++) {
        const d = new Date(monday);
        d.setDate(monday.getDate() + i);
        dates.push(formatDate(d));
      }

      // è·å–æ‰€æœ‰å‘˜å·¥æœ¬å‘¨æ•°æ®
      const { data: allData } = await supabase
        .from('daily_progress')
        .select('*')
        .in('date', dates)
        .order('employee_name', { ascending: true })
        .order('date', { ascending: true });

      // æŒ‰å‘˜å·¥åˆ†ç»„
      const employeeData = {};
      for (const row of allData) {
        if (!employeeData[row.employee_name]) employeeData[row.employee_name] = {};
        if (!employeeData[row.employee_name][row.task_dimension]) {
          employeeData[row.employee_name][row.task_dimension] = {};
        }
        employeeData[row.employee_name][row.task_dimension][row.date] = row;
      }

      // æ„å»ºè¡¨æ ¼
      let html = `<table>
        <thead>
          <tr>
            <th>å‘˜å·¥</th>
            <th>å·¥ä½œç»´åº¦</th>
            ${dates.map(d => `<th>${d}</th>`).join('')}
          </tr>
        </thead>
        <tbody>`;

      for (const emp of Object.keys(employeeData).sort()) {
        for (const dim of DIMENSIONS) {
          const cells = dates.map(date => {
            const record = employeeData[emp][dim]?.[date];
            if (!record) return '<td>â€”</td>';

            // æ£€æµ‹è¿ç»­é‡å¤ï¼ˆç®€å•ç‰ˆï¼šå’Œå‰ä¸€å¤©æ¯”ï¼‰
            let isRepeated = false;
            let repeatCount = 1;
            for (let i = 1; i < dates.length; i++) {
              const prevDate = dates[i - 1];
              const currDate = dates[i];
              const prev = employeeData[emp][dim]?.[prevDate];
              const curr = employeeData[emp][dim]?.[currDate];
              if (prev && curr && prev.progress_status === curr.progress_status && prev.notes === curr.notes) {
                // è¿™é‡Œç®€åŒ–ï¼šåªè¦å’Œå‰ä¸€å¤©ç›¸åŒï¼Œå°±è®¡æ•°
                // å®é™…å¯åšæ»‘åŠ¨çª—å£ï¼Œä½†ä¸ºç®€å•ï¼Œæˆ‘ä»¬æ ‡è¿ç»­3å¤©ç›¸åŒ
              }
            }

            // ğŸ”´ æ›´å‡†ç¡®çš„é‡å¤æ£€æµ‹ï¼ˆè¿ç»­3å¤©ç›¸åŒï¼‰
            let highlightClass = '';
            let sameCount = 1;
            let maxSame = 1;
            for (let i = 1; i < dates.length; i++) {
              const a = employeeData[emp][dim]?.[dates[i-1]];
              const b = employeeData[emp][dim]?.[dates[i]];
              if (a && b && a.progress_status === b.progress_status && a.notes === b.notes) {
                sameCount++;
                maxSame = Math.max(maxSame, sameCount);
              } else {
                sameCount = 1;
              }
            }
            if (maxSame >= 3) highlightClass = 'highlight-red';
            else if (maxSame >= 2) highlightClass = 'highlight-yellow';

            return `<td class="${highlightClass}">${record.progress_status}<br><small>${record.notes || 'â€”'}</small></td>`;
          });
          html += `<tr><td>${emp}</td><td>${dim}</td>${cells.join('')}</tr>`;
        }
      }

      html += `</tbody></table>`;
      html += `<p style="font-size:12px; margin-top:10px;">
        <span style="background:#ffe6e6; padding:2px 5px;">ğŸ”´ çº¢è‰²</span>ï¼šè¿ç»­3å¤©æ— è¿›å±•  
        <span style="background:#fff7e6; padding:2px 5px;">ğŸŸ¡ é»„è‰²</span>ï¼šè¿ç»­2å¤©æ— è¿›å±•
      </p>`;

      document.getElementById('weekendContent').innerHTML = html;
    }

    // é¡µé¢åŠ è½½
    window.onload = function() {
      // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆç®€å•æœ¬åœ°å­˜å‚¨ï¼‰
      const saved = localStorage.getItem('pg_employee');
      if (saved) {
        currentEmployee = saved;
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('mainSection').classList.remove('hidden');
        renderPage();
      }
    };
  </script>
</body>
</html>